# TODO mitr: Fix file with the three urls

import os
import requests
import PyPDF2
import fitz

# URL of the website with the PDF files
url = 'https://opendata.swiss/de/dataset/schweizerischer-wohnimmobilienpreisindex'
url = 'https://opendata.swiss/de/dataset/schweizerischer-wohnimmobilienpreisindex-impi'
url = 'https://opendata.swiss/de/dataset/schweizerischer-wohnimmobilienpreisindex-4q-2019-100'

# Location for the text file(s)
output_folder = 'output'

# Check if the folder already exists, if not, create it
if not os.path.exists(output_folder):
    os.makedirs(output_folder)

# Download list of PDF files on the website
response = requests.get(url)
pdf_urls = []
for line in response.iter_lines():
    line = line.decode('utf-8')
    if line.endswith('.pdf'):
        pdf_urls.append(url + line)

# Download any PDF file and convert it to text
for pdf_url in pdf_urls:
    # Download PDF file
    response = requests.get(pdf_url)
    filename = pdf_url.split('/')[-1]
    with open(filename, 'wb') as file:
        file.write(response.content)

    # Open PDF file
    with open(filename, 'rb') as file:
        # Use PyPDF2 to read PDF file
        pdf_reader = PyPDF2.PdfFileReader(file)

        # Number of pages in PDF document
        num_pages = pdf_reader.getNumPages()

        # Open PDF file with PyMuPDF
        with fitz.open(filename) as doc:
            for page_number in range(num_pages):
                # Extract page from PyMuPDF document
                page = doc.loadPage(page_number)

                # Convert page to text
                text = page.getText()

                # Save text to file
                text_filename = os.path.join(output_folder, f'{filename}_{page_number+1}.txt')
                with open(text_filename, 'w', encoding='utf-8') as text_file:
                    text_file.write(text)

    # Delete PDF file
    os.remove(filename)